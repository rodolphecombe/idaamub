#textdomain wesnoth-loi
#undef INSERT_INTO_ITEMS SORT ITEM_NUMBER
#define INSERT_INTO_ITEMS SORT ITEM_NUMBER
    [loti_item_storage_add]
        number = {ITEM_NUMBER}
        sort = {SORT}
    [/loti_item_storage_add]
#enddef
#undef CANNOT_TAKE_OPTIONS
#define CANNOT_TAKE_OPTIONS
    [option]
        label=_"Store it."
        [show_if]
            [not]
                [variable]
                    name=no_inventory
                    equals=yes
                [/variable]
            [/not]
        [/show_if]
        [command]
            {INSERT_INTO_ITEMS $item_list.object[$item_number].sort| $item_list.object[$item_number].number|}
            [remove_item]
                x,y=$x1,$y1
                image=$item_list.object[$item_number].image
            [/remove_item]
            {CLEAR_VARIABLE items[$k]}
            {VARIABLE_OP l add -1}
            {VARIABLE picked 1}
        [/command]
    [/option]
    [option]
        message=_"Transmute it to gold. Currently having $identical_count such items stored."
        [show_if]
            [have_unit]
                x,y=$x1,$y1
                ability=transmutation
            [/have_unit]
        [/show_if]
        [command]
            {VARIABLE shall_take 0}
            {VARIABLE gold_created $item_list.object[$item_number].price}
                {VARIABLE_OP gold_created divide 10}
                [gold]
                    side=$unit.side
                    amount=$gold_created
                [/gold]
                [remove_item]
                    x,y=$x1,$y1
                    image=$item_list.object[$item_number].image
                    [/remove_item]
                    [message]
                        speaker=narrator
                        message="The item was transmuted to $gold_created gold"
                    [/message]
                    {CLEAR_VARIABLE items[$k]}
                        {CLEAR_VARIABLE gold_created}
                        {VARIABLE_OP l add -1}
                        {VARIABLE picked 1}
                    [/command]
                [/option]
                [option]
                    label=_"Sell it. Currently having $identical_count such items stored."
                    [show_if]
                        [variable]
                            name=is_on_shop
                            equals=yes
                        [/variable]
                    [/show_if]
                    [command]
                        {VARIABLE shall_take 0}
                        {VARIABLE gold_created $item_list.object[$item_number].price}
                            {VARIABLE_OP gold_created divide 3}
                            [message]
                                speaker=narrator
                                message="The item will be sold for $gold_created gold. Do you agree?"
                                [option]
                                    message="Yes"
                                    [command]
                                        [gold]
                                            side=$unit.side
                                            amount=$gold_created
                                        [/gold]
                                        [remove_item]
                                            x,y=$x1,$y1
                                            image=$item_list.object[$item_number].image
                                            [/remove_item]
                                            {CLEAR_VARIABLE items[$k]}
                                                {CLEAR_VARIABLE gold_created}
                                                {VARIABLE_OP l add -1}
                                                {VARIABLE picked 1}
                                            [/command]
                                        [/option]
                                        [option]
                                            message="No"
                                            [command]
                                                {CLEAR_VARIABLE gold_created}
                                            [/command]
                                        [/option]
                                    [/message]
                                [/command]
                            [/option]
    [option]
        label=_"Leave it on the ground."
        [command]
        [/command]
    [/option]
#enddef

#undef GENERATE_ITEM_LIST
#define GENERATE_ITEM_LIST
    [set_variables]
        name=item_list
        mode=replace
        [literal]
            {ITEM_LIST}
        [/literal]
    [/set_variables]
    [describe_all_objects]
        array=item_list.object
    [/describe_all_objects]
    [clear_item_list_cache]
    [/clear_item_list_cache]
    [set_variables]     #Item types are used in the code, and translating them will cause errors. This should make the usage of language names easy
        name=item_type_translations
        [value]
            [armour]
                translation= _ "armour"
            [/armour]
            [helm]
                translation= _ "helm"
            [/helm]
            [gauntlets]
                translation= _ "gauntlets"
            [/gauntlets]
            [boots]
                translation= _ "boots"
            [/boots]
            [sword]
                translation= _ "sword"
            [/sword]
            [axe]
                translation= _ "axe"
            [/axe]
            [staff]
                translation= _ "staff"
            [/staff]
            [bow]
                translation= _ "bow"
            [/bow]
            [dagger]
                translation= _ "dagger"
            [/dagger]
            [xbow]
                translation= _ "crossbow"
            [/xbow]
            [knife]
                translation= _ "knife"
            [/knife]
            [mace]
                translation= _ "mace"
            [/mace]
            [spear]
                translation= _ "spear"
            [/spear]
            [polearm]
                translation= _ "polearm"
            [/polearm]
            [sling]
                translation= _ "sling"
            [/sling]
            [thunderstick]
                translation= _ "thunderstick"
            [/thunderstick]
            [claws]
                translation= _ "metal claws"
            [/claws]
            [essence]
                translation= _ "otherworldly essence"
            [/essence]
            [amulet]
                translation= _ "amulet"
            [/amulet]
            [ring]
                translation= _ "ring"
            [/ring]
            [shield]
                translation= _ "shield"
            [/shield]
            [limited]
                translation= _ "limited"
            [/limited]
            [potion]
                translation= _ "potion"
            [/potion]
        [/value]
    [/set_variables]
#enddef

#undef REMOVE_OBJECT SORT
#define REMOVE_OBJECT SORT
    [store_unit]
        [filter]
            x,y=$x1,$y1
        [/filter]
        variable=gifted
        kill=no
    [/store_unit]
    {VARIABLE i 0}
    [while]
        [variable]
            name=i
            less_than=$gifted.modifications.object.length
        [/variable]
        [do]
            [if]
                [variable]
                    name=gifted.modifications.object[$i].sort
                    equals={SORT}
                [/variable]
                [then]
                    [item]
                        x,y=$x1,$y1
                        image=$gifted.modifications.object[$i].image
                        halo=halo/misc/leadership-flare-1.png:20,halo/misc/leadership-flare-2.png:20,halo/misc/leadership-flare-3.png:20,halo/misc/leadership-flare-4.png:20,halo/misc/leadership-flare-4.png:20,halo/misc/leadership-flare-6.png:20,halo/misc/leadership-flare-7.png:20,halo/misc/leadership-flare-8.png:20,halo/misc/leadership-flare-9.png:20,halo/misc/leadership-flare-10.png:20,halo/misc/leadership-flare-11.png:20,halo/misc/leadership-flare-12.png:20,halo/misc/leadership-flare-13.png:20,misc/blank-hex.png:1000
                    [/item]
                    {VARIABLE_OP items_dropped add 1}
                    [set_variables]
                        name=items_to_add
                        mode=append
                        [value]
                            x=$x1
                            y=$y1
                            type=$gifted.modifications.object[$i].number
                            sort={SORT}
                        [/value]
                    [/set_variables]
                    {PLACE_ITEM_EVENT $x1 $y1}
                    {CLEAR_VARIABLE gifted.modifications.object[$i]}
                [/then]
                [else]
                    [set_variable]
                        name=i
                        add=1
                    [/set_variable]
                [/else]
            [/if]
        [/do]
    [/while]
    {CLEAR_VARIABLE i}
    [unstore_unit]
        variable=gifted
        find_vacant=no
    [/unstore_unit]
    {CLEAR_VARIABLE gifted}
#enddef

#undef ITEM_PICK
#define ITEM_PICK
    [event]
        name=item_pick
        first_time_only=no
        {VARIABLE picked 0}
        {FOREACH items k}
            [if]
                [variable]
                    name=x1
                    equals=$items[$k].x
                [/variable]
                [and]
                    [variable]
                        name=y1
                        equals=$items[$k].y
                    [/variable]
                [/and]
                [then]
                    [set_variable]
                        name=l
                        value=$k
                    [/set_variable]
                    [while]
                        [variable]
                            name=o
                            less_than=$item_list.object.length
                        [/variable]
                        [do]
                            [if]
                                [variable]
                                    name=item_list.object[$o].number
                                    equals=$items[$l].type
                                [/variable]
                                [then]
                                    {VARIABLE item_number $o}
                                [/then]
                            [/if]
                            [set_variable]
                                name=o
                                add=1
                            [/set_variable]
                        [/do]
                    [/while]
                    {CLEAR_VARIABLE o}
                    [if]
                        [variable]
                            name=item_list.object[$item_number].number
                            greater_than=530
                        [/variable]
                        [and]
                            [variable]
                                name=item_list.object[$item_number].number
                                less_than_equal_to=600
                            [/variable]
                        [/and]
                        [then]
                            {VARIABLE item_list.object[$item_number].sort $items[$l].sort}
                        [/then]
                    [/if]

                    # Determine if this item can be equipped.
                    [can_equip_item]
                        find_in=unit
                        item_number=$item_number
                        to_variable=can_take
                    [/can_equip_item]
                    
                    [switch]
                        variable=item_list.object[$item_number].sort
                        [case]
                            value=limited
                            {VARIABLE can_take_this_weapon 1}
                            {FOREACH unit.object thing_number}
                                [if]
                                    [variable]
                                        name=unit.modifications.object[$thing_number].number
                                        equals=$item_list.object[$item_number].number
                                    [/variable]
                                    [then]
                                        {VARIABLE can_take_this_weapon 0}
                                    [/then]
                                [/if]
                            {NEXT thing_number}
                            [if]
                                [variable]
                                    name=can_take_this_weapon
                                    equals=0
                                [/variable]
                                [then]
                                    {VARIABLE can_take _"This unit already has this item."}
                                [/then]
                            [/if]
                        [/case]
                        [case]
                            value=food
                            [remove_item]
                                x,y=$x1,$y1
                                image=$item_list.object[$item_number].image
                            [/remove_item]
                            {VARIABLE been_a_gem 1}
                            [if]
                                [variable]
                                    name=food_counter
                                    equals=0
                                [/variable]
                                [then]
                                    {VARIABLE_OP food_counter add 1}
                                    [message]
                                        speaker=unit
                                        message="I sure needed that."
                                    [/message]
                                [/then]
                                [else]
                                    {VARIABLE_OP food_counter add 1}
                                    [message]
                                        speaker=unit
                                        message="I found some food."
                                    [/message]
                                [/else]
                            [/if]
                            {CLEAR_VARIABLE items[$l]}
                            {VARIABLE_OP l add -1}
                            {VARIABLE picked 1}
                        [/case]
                        [case]
                            value=gold
                            [remove_item]
                                x,y=$x1,$y1
                                image=$item_list.object[$item_number].image
                            [/remove_item]
                            {VARIABLE been_a_gem 1}
                            [switch]
                                variable=item_list.object[$item_number].number
                                [case]
                                    value=12
                                    [gold]
                                        side=$side_number
                                        amount=5
                                    [/gold]
                                    [message]
                                        speaker=unit
                                        message="I found 5 gold."
                                    [/message]
                                [/case]
                                [case]
                                    value=13
                                    [gold]
                                        side=$side_number
                                        amount=15
                                    [/gold]
                                    [message]
                                        speaker=unit
                                        message="I found 15 gold."
                                    [/message]
                                [/case]
                                [case]
                                    value=20
                                    [gold]
                                        side=$side_number
                                        amount=2
                                    [/gold]
                                    [message]
                                        speaker=unit
                                        message="I found 2 gold."
                                    [/message]
                                [/case]
                                [case]
                                    value=31
                                    [gold]
                                        side=$side_number
                                        amount=20
                                    [/gold]
                                    [message]
                                        speaker=unit
                                        message="I found 20 gold."
                                    [/message]
                                [/case]
                                [case]
                                    value=32
                                    [gold]
                                        side=$side_number
                                        amount=30
                                    [/gold]
                                    [message]
                                        speaker=unit
                                        message="I found 30 gold."
                                    [/message]
                                [/case]
                                [case]
                                    value=33
                                    [gold]
                                        side=$side_number
                                        amount=10
                                    [/gold]
                                    [message]
                                        speaker=unit
                                        message="I found 10 gold."
                                    [/message]
                                [/case]
                                [case]
                                    value=34
                                    [gold]
                                        side=$side_number
                                        amount=1
                                    [/gold]
                                    [message]
                                        speaker=unit
                                        message="I found 1 gold."
                                    [/message]
                                [/case]
                                [case]
                                    value=103
                                    [gold]
                                        side=$side_number
                                        amount=50
                                    [/gold]
                                    [message]
                                        speaker=unit
                                        message="I found 50 gold."
                                    [/message]
                                [/case]
                                [case]
                                    value=127
                                    [gold]
                                        side=$side_number
                                        amount=70
                                    [/gold]
                                    [message]
                                        speaker=unit
                                        message="I found 70 gold."
                                    [/message]
                                [/case]
                                [case]
                                    value=144
                                    [gold]
                                        side=$side_number
                                        amount=100
                                    [/gold]
                                    [message]
                                        speaker=unit
                                        message="I found 100 gold."
                                    [/message]
                                [/case]
                                [case]
                                    value=227
                                    [gold]
                                        side=$side_number
                                        amount=150
                                    [/gold]
                                    [message]
                                        speaker=unit
                                        message="I found 150 gold."
                                    [/message]
                                [/case]
                                [case]
                                    value=290
                                    [gold]
                                        side=$side_number
                                        amount=200
                                    [/gold]
                                    [message]
                                        speaker=unit
                                        message="I found 200 gold."
                                    [/message]
                                [/case]
                                [case]
                                    value=303
                                    [gold]
                                        side=$side_number
                                        amount=300
                                    [/gold]
                                    [message]
                                        speaker=unit
                                        message="I found 300 gold."
                                    [/message]
                                [/case]
                            [/switch]
                            {CLEAR_VARIABLE items[$l]}
                            {VARIABLE_OP l add -1}
                            {VARIABLE picked 1}
                        [/case]
                        [case]
                            value=potion
                            [if]
                                [variable]
                                    name=item_list.object[$item_number].number
                                    equals=106
                                [/variable]
                                [then]
                                    [if]
                                        [variable]
                                            name=unit.variables.healed_this_turn
                                            equals=yes
                                        [/variable]
                                        [then]
                                            {VARIABLE can_take _"This unit had already a healing potion in this turn."}
                                        [/then]
                                        [else]
                                            {VARIABLE fully_healed 1}
                                        [/else]
                                    [/if]
                                [/then]
                            [/if]
                            [if]
                                [variable]
                                    name=item_list.object[$item_number].number
                                    equals=43
                                [/variable]
                                [or]
                                    [variable]
                                        name=item_list.object[$item_number].number
                                        equals=205
                                    [/variable]
                                [/or]
                                [then]
                                    [if]
                                        [variable]
                                            name=unit.variables.healed_this_turn
                                            equals=yes
                                        [/variable]
                                        [then]
                                            {VARIABLE can_take _"This unit had already a healing potion in this turn."}
                                        [/then]
                                        [else]
                                            {VARIABLE healed 1}
                                        [/else]
                                    [/if]
                                [/then]
                            [/if]
                        [/case]
                    [/switch]
                    [if]
                        [variable]
                            name=been_a_gem
                            not_equals=1
                        [/variable]
                        [then]
                            [if]
                                [variable]
                                    name=item_list.object[$item_number].sort
                                    contains="potion"
                                [/variable]
                                [or]
                                    [variable]
                                        name=item_list.object[$item_number].sort
                                        equals="limited"
                                    [/variable]
                                [/or]
                                [then]
                                    {VARIABLE name_unequipped _"irrelevant"}
                                [/then]
                                [else]
                                    {VARIABLE name_unequipped _"none"}
                                    {FOREACH unit.modifications.object ot}
                                        [if]
                                            [variable]
                                                name=unit.modifications.object[$ot].sort
                                                equals=$item_list.object[$item_number].sort
                                            [/variable]
                                            [then]
                                                {VARIABLE name_unequipped $unit.modifications.object[$ot].name}
                                            [/then]
                                        [/if]
                                    {NEXT ot}
                                [/else]
                            [/if]
                            {VARIABLE in_foreach "item_storage.$item_list.object[$item_number].sort"}
                            [set_variable]
                                name=in_foreach_length
                                to_variable=$in_foreach|.length
                            [/set_variable]
                            {VARIABLE identical_count 0}
                            {VARIABLE ot 0}
                            [while]
                                [variable]
                                    name=ot
                                    less_than=$in_foreach_length
                                [/variable]
                                [do]
                                    [if]
                                        [variable]
                                            name=$in_foreach|[$ot].type
                                            equals=$item_list.object[$item_number].number
                                        [/variable]
                                        [then]
                                            {VARIABLE_OP identical_count add 1}
                                        [/then]
                                    [/if]
                                    [set_variable]
                                        name=ot
                                        add=1
                                    [/set_variable]
                                [/do]
                            [/while]
                            {CLEAR_VARIABLE in_foreach,in_foreach_length,ot}
                            [if]
                                [variable]
                                    name=can_take
                                    equals=1
                                [/variable]
                                [then]
                                    [message]
                                        speaker=narrator
                                        caption=$item_list.object[$item_number].name
                                        message= _"$item_list.object[$item_number].description

Item of the same type that will be unequipped: $name_unequipped
Take this item?"
                                        image=$item_list.object[$item_number].image
                                        side_for=$side_number
                                        [option]
                                            label=_"Take it."
                                            [command]
                                                {VARIABLE shall_take 1}
                                            [/command]
                                        [/option]
                                        [option]
                                            label=_"Store it. Currently having $identical_count such items stored."
                                            [show_if]
                                                [not]
                                                    [variable]
                                                        name=no_inventory
                                                        equals=yes
                                                    [/variable]
                                                [/not]
                                            [/show_if]
                                            [command]
                                                {VARIABLE shall_take 0}
                                                {INSERT_INTO_ITEMS $item_list.object[$item_number].sort| $item_list.object[$item_number].number}
                                                [remove_item]
                                                    x,y=$x1,$y1
                                                    image=$item_list.object[$item_number].image
                                                [/remove_item]
                                                {CLEAR_VARIABLE items[$k]}
                                                {VARIABLE_OP l add -1}
                                                {VARIABLE picked 1}
                                            [/command]
                                        [/option]
                                        [option]
                                            message=_"Transmute it to gold. Currently having $identical_count such items stored."
                                            [show_if]
                                                    [have_unit]
                                                        x,y=$x1,$y1
                                                        ability=transmutation
                                                    [/have_unit]
                                            [/show_if]
                                            [command]
                                                {VARIABLE shall_take 0}
                                                {VARIABLE gold_created $item_list.object[$item_number].price}
                                                {VARIABLE_OP gold_created divide 10}
                                                [gold]
                                                    side=$unit.side
                                                    amount=$gold_created
                                                [/gold]
                                                [remove_item]
                                                    x,y=$x1,$y1
                                                    image=$item_list.object[$item_number].image
                                                [/remove_item]
                                                [message]
                                                    speaker=narrator
                                                    message="The item was transmuted to $gold_created gold"
                                                [/message]
                                                {CLEAR_VARIABLE items[$k]}
                                                {CLEAR_VARIABLE gold_created}
                                                {VARIABLE_OP l add -1}
                                                {VARIABLE picked 1}
                                            [/command]
                                        [/option]
                                        [option]
                                            label=_"Sell it. Currently having $identical_count such items stored."
                                            [show_if]
                                                    [variable]
                                                        name=is_on_shop
                                                        equals=yes
                                                    [/variable]
                                            [/show_if]
                                            [command]
                                                {VARIABLE shall_take 0}
                                                {VARIABLE gold_created $item_list.object[$item_number].price}
                                                {VARIABLE_OP gold_created divide 3}
                                                [message]
                                                    speaker=narrator
                                                    message="The item will be sold for $gold_created gold. Do you agree?"
                                                    [option]
                                                        message="Yes"
                                                        [command]
                                                            [gold]
                                                                side=$unit.side
                                                                amount=$gold_created
                                                            [/gold]
                                                            [remove_item]
                                                                x,y=$x1,$y1
                                                                image=$item_list.object[$item_number].image
                                                            [/remove_item]
                                                            {CLEAR_VARIABLE items[$k]}
                                                            {CLEAR_VARIABLE gold_created}
                                                            {VARIABLE_OP l add -1}
                                                            {VARIABLE picked 1}
                                                        [/command]
                                                    [/option]
                                                    [option]
                                                        message="No"
                                                        [command]
                                                            {CLEAR_VARIABLE gold_created}
                                                        [/command]
                                                    [/option]
                                                [/message]
                                            [/command]
                                        [/option]
                                        [option]
                                            label=_"Leave it on the ground."
                                            [command]
                                                {VARIABLE shall_take 0}
                                            [/command]
                                        [/option]
                                    [/message]
                                [/then]
                                [else]
                                    {VARIABLE shall_take 0}
                                    [message]
                                        speaker=narrator
                                        caption=$item_list.object[$item_number].name
                                        message="$item_list.object[$item_number].description
<span color='red'>$can_take </span>"
                                        image=$item_list.object[$item_number].image
                                        side_for=$side_number
                                        [option]
                                            label=_"Store it. Currently having $identical_count such items stored."
                                            [show_if]
                                                [not]
                                                    [variable]
                                                        name=no_inventory
                                                        equals=yes
                                                    [/variable]
                                                [/not]
                                            [/show_if]
                                            [command]
                                                {INSERT_INTO_ITEMS $item_list.object[$item_number].sort| $item_list.object[$item_number].number}
                                                [remove_item]
                                                    x,y=$x1,$y1
                                                    image=$item_list.object[$item_number].image
                                                [/remove_item]
                                                {CLEAR_VARIABLE items[$k]}
                                                {VARIABLE_OP l add -1}
                                                {VARIABLE picked 1}
                                            [/command]
                                        [/option]
                                        [option]
                                            message=_"Transmute it to gold. Currently having $identical_count such items stored."
                                            [show_if]
                                                    [have_unit]
                                                        x,y=$x1,$y1
                                                        ability=transmutation
                                                    [/have_unit]
                                            [/show_if]
                                            [command]
                                                {VARIABLE shall_take 0}
                                                {VARIABLE gold_created $item_list.object[$item_number].price}
                                                {VARIABLE_OP gold_created divide 10}
                                                [gold]
                                                    side=$unit.side
                                                    amount=$gold_created
                                                [/gold]
                                                [remove_item]
                                                    x,y=$x1,$y1
                                                    image=$item_list.object[$item_number].image
                                                [/remove_item]
                                                [message]
                                                    speaker=narrator
                                                    message="The item was transmuted to $gold_created gold"
                                                [/message]
                                                {CLEAR_VARIABLE items[$k]}
                                                {CLEAR_VARIABLE gold_created}
                                                {VARIABLE_OP l add -1}
                                                {VARIABLE picked 1}
                                            [/command]
                                        [/option]
                                        [option]
                                            label=_"Sell it. Currently having $identical_count such items stored."
                                            [show_if]
                                                    [variable]
                                                        name=is_on_shop
                                                        equals=yes
                                                    [/variable]
                                            [/show_if]
                                            [command]
                                                {VARIABLE shall_take 0}
                                                {VARIABLE gold_created $item_list.object[$item_number].price}
                                                {VARIABLE_OP gold_created divide 3}
                                                [message]
                                                    speaker=narrator
                                                    message="The item will be sold for $gold_created gold. Do you agree?"
                                                    [option]
                                                        message="Yes"
                                                        [command]
                                                            [gold]
                                                                side=$unit.side
                                                                amount=$gold_created
                                                            [/gold]
                                                            [remove_item]
                                                                x,y=$x1,$y1
                                                                image=$item_list.object[$item_number].image
                                                            [/remove_item]
                                                            {CLEAR_VARIABLE items[$k]}
                                                            {CLEAR_VARIABLE gold_created}
                                                            {VARIABLE_OP l add -1}
                                                            {VARIABLE picked 1}
                                                        [/command]
                                                    [/option]
                                                    [option]
                                                        message="No"
                                                        [command]
                                                            {CLEAR_VARIABLE gold_created}
                                                        [/command]
                                                    [/option]
                                                [/message]
                                            [/command]
                                        [/option]
                                        [option]
                                            label=_"Leave it on the ground."
                                            [command]
                                            [/command]
                                        [/option]
                                    [/message]
                                [/else]
                            [/if]
                            {CLEAR_VARIABLE identical_count}
                            [if]
                                [variable]
                                    name=shall_take
                                    equals=1
                                [/variable]
                                [then]
                                    [remove_item]
                                        x,y=$x1,$y1
                                        image=$item_list.object[$item_number].image
                                    [/remove_item]
                                    [if]
                                        [variable]
                                            name=item_list.object[$item_number].sort
                                            contains=potion
                                        [/variable]
                                        [or]
                                            [variable]
                                                name=item_list.object[$item_number].sort
                                                equals=limited
                                            [/variable]
                                        [/or]
                                        [else]
                                            {REMOVE_OBJECT $item_list.object[$item_number].sort}
                                        [/else]
                                    [/if]
                                    [if]
                                        [variable]
                                            name=item_list.object[$item_number].number
                                            greater_than=530
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=item_list.object[$item_number].number
                                                less_than_equal_to=600
                                            [/variable]
                                        [/and]
                                        [then]
                                            [if]
                                                [variable]
                                                    name=item_list.object[$item_number].sort
                                                    equals=helm
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=item_list.object[$item_number].sort
                                                        equals=boots
                                                    [/variable]
                                                [/or]
                                                [or]
                                                    [variable]
                                                        name=item_list.object[$item_number].sort
                                                        equals=gauntlets
                                                    [/variable]
                                                [/or]
                                                [and]
                                                    [variable]
                                                        name=item_list.object[$item_number].defence
                                                        greater_than_equal_to=1
                                                    [/variable]
                                                [/and]
                                                [then]
                                                    {VARIABLE former_defence $item_list.object[$item_number].defence}
                                                    {VARIABLE_OP item_list.object[$item_number].defence divide 3}
                                                [/then]
                                            [/if]
                                        [/then]
                                    [/if]
                                    [set_variables]
                                        name=added_object
                                        to_variable=item_list.object[$item_number]
                                    [/set_variables]
                                    [insert_tag]
                                        name=object
                                        variable=added_object
                                    [/insert_tag]
                                    {CLEAR_VARIABLE added_object}
                                    [if]    #A few hacks to check some items that need some special code when picked up
                                        [variable]
                                            name=item_list.object[$item_number].number
                                            equals=16
                                        [/variable]
                                        [then]
                                            [store_unit]
                                                [filter]
                                                    x,y=$x1,$y1
                                                [/filter]
                                                variable=advanced
                                            [/store_unit]
                                            {CLEAR_VARIABLE advanced.variables.starving}
                                            [unstore_unit]
                                                variable=advanced
                                                find_vacant=no
                                            [/unstore_unit]
                                            {CLEAR_VARIABLE advanced}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
                                            name=item_list.object[$item_number].number
                                            equals=89
                                        [/variable]
                                        [then]
                                            [store_unit]
                                                [filter]
                                                    x,y=$x1,$y1
                                                [/filter]
                                                variable=advanced
                                            [/store_unit]
                                            [set_variables]
                                                name=advanced.modifications.trait[$advanced.modifications.trait.length]
                                                mode=replace
                                                [value]
                                                    id=fearless
                                                    male_name= _ "fearless"
                                                    female_name= _ "female^fearless"
                                                    description= _ "Fights normally during unfavorable times of day/night"
                                                    [effect]
                                                        apply_to="fearless"
                                                    [/effect]
                                                [/value]
                                            [/set_variables]
                                            [unstore_unit]
                                                variable=advanced
                                                find_vacant=no
                                            [/unstore_unit]
                                            {CLEAR_VARIABLE advanced}
                                        [/then]
                                    [/if]
                                    {CLEAR_VARIABLE items[$k]}
                                    {VARIABLE_OP l add -1}
                                    {VARIABLE picked 1}
                                    [if]
                                        [variable]
                                            name=item_list.object[$item_number].number
                                            greater_than=530
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=item_list.object[$item_number].number
                                                less_than_equal_to=600
                                            [/variable]
                                        [/and]
                                        [then]
                                            [if]
                                                [variable]
                                                    name=item_list.object[$item_number].sort
                                                    equals=helm
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=item_list.object[$item_number].sort
                                                        equals=boots
                                                    [/variable]
                                                [/or]
                                                [or]
                                                    [variable]
                                                        name=item_list.object[$item_number].sort
                                                        equals=gauntlets
                                                    [/variable]
                                                [/or]
                                                [and]
                                                    [variable]
                                                        name=item_list.object[$item_number].defence
                                                        greater_than_equal_to=1
                                                    [/variable]
                                                [/and]
                                                [then]
                                                    {VARIABLE item_list.object[$item_number].defence $former_defence}
                                                    {CLEAR_VARIABLE former_defence}
                                                [/then]
                                            [/if]
                                        [/then]
                                    [/if]
                                    {UPDATE_STATS}
                                [/then]
                            [/if]
                            {CLEAR_VARIABLE shall_take}
                        [/then]
                    [/if]
                    [set_variable]
                        name=k
                        value=$l
                    [/set_variable]
                [/then]
            [/if]
        {NEXT k}
        {CLEAR_VARIABLE been_a_gem}
        {FOREACH items_to_add i}
            [if]
                [variable]
                    name=$items_to_add[$i].sort
                    contains=potion
                [/variable]
                [or]
                    [variable]
                        name=$items_to_add[$i].sort
                        equals=limited
                    [/variable]
                [/or]
                [else]
                    [set_variables]
                        name=items
                        mode=append
                        [value]
                            x=$x1
                            y=$y1
                            type=$items_to_add[$i].type
                            sort=$items_to_add[$i].sort
                        [/value]
                    [/set_variables]
                [/else]
            [/if]
        {NEXT i}
        [if]
            [variable]
                name=picked
                equals=0
            [/variable]
            [or]
                [variable]
                    name=been_a_gem
                    equals=1
                [/variable]
            [/or]
            [then]
                [if]
                    [variable]
                        name=been_a_gem
                        equals=1
                    [/variable]
                    [then]
                        [fire_event]
                            name=item_pick
                            [primary_unit]
                                id=$unit.id
                            [/primary_unit]
                        [/fire_event]
                    [/then]
                    [else]
                        [allow_undo]
                        [/allow_undo]
                    [/else]
                [/if]
            [/then]
            [else]
                [fire_event]    #Just for the case if collecting items was meant to be used for something
                    name=item picked
                    [primary_unit]
                        id=$unit.id
                    [/primary_unit]
                [/fire_event]
            [/else]
        [/if]
        {CLEAR_VARIABLE items_to_add}
        {CLEAR_VARIABLE picked}
        {CLEAR_VARIABLE l}
        {CLEAR_VARIABLE item_number,name_unequipped}
        {CLEAR_VARIABLE can_take,can_take_this_weapon}
    [/event]
#enddef
